<!DOCTYPE html>
<html>
<head>
    <title>Telegram Snake Game</title>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #111;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="300" height="300"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 10;
        const tileCount = 30;

        let snake = [{x: 15, y: 15}];
        let dx = 1;
        let dy = 0;
        let apple = {x: 5, y: 5};
        let score = 0;
        let speed = 7;

        function gameLoop() {
            if (isGameOver()) {
                showGameOver();
                return;
            }

            setTimeout(() => {
                clearCanvas();
                drawApple();
                moveSnake();
                drawSnake();
                gameLoop();
            }, 1000 / speed);
        }

        function clearCanvas() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function drawSnake() {
            snake.forEach(part => {
                ctx.fillStyle = 'green';
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize, gridSize);
            });
        }

        function drawApple() {
            ctx.fillStyle = 'red';
            ctx.fillRect(apple.x * gridSize, apple.y * gridSize, gridSize, gridSize);
        }

        function moveSnake() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};

            // Wrap around screen
            if (head.x < 0) head.x = tileCount - 1;
            if (head.x >= tileCount) head.x = 0;
            if (head.y < 0) head.y = tileCount - 1;
            if (head.y >= tileCount) head.y = 0;

            snake.unshift(head);

            if (head.x === apple.x && head.y === apple.y) {
                score++;
                placeApple();
            } else {
                snake.pop();
            }
        }

        function placeApple() {
            apple = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };

            while (snake.some(part => part.x === apple.x && part.y === apple.y)) {
                apple = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
            }
        }

        function isGameOver() {
            for (let i = 1; i < snake.length; i++) {
                if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) {
                    return true;
                }
            }
            return false;
        }

        function showGameOver() {
            ctx.fillStyle = 'white';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Game Over!', canvas.width/2, canvas.height/2 - 20);
            ctx.font = '20px Arial';
            ctx.fillText(`Score: ${score}`, canvas.width/2, canvas.height/2 + 20);

            // Кнопка "Играть снова" для Telegram
            if (window.Telegram && Telegram.WebApp) {
                const button = document.createElement('button');
                button.textContent = 'Play Again';
                button.style.position = 'absolute';
                button.style.left = '50%';
                button.style.top = '60%';
                button.style.transform = 'translateX(-50%)';
                button.onclick = () => Telegram.WebApp.reload();
                document.body.appendChild(button);
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp' && dy !== 1) {
                dx = 0;
                dy = -1;
            } else if (e.key === 'ArrowDown' && dy !== -1) {
                dx = 0;
                dy = 1;
            } else if (e.key === 'ArrowLeft' && dx !== 1) {
                dx = -1;
                dy = 0;
            } else if (e.key === 'ArrowRight' && dx !== -1) {
                dx = 1;
                dy = 0;
            }
        });

        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
        }

        placeApple();
        gameLoop();
    </script>
</body>
</html>