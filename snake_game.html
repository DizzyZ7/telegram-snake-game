<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake Game</title>
    <style>
        :root {
            --btn-color: #4CAF50;
            --btn-active: #45a049;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            touch-action: manipulation;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }
        canvas {
            display: block;
            background: #111;
            border: 2px solid #333;
            margin: 10px auto;
        }
        #controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            background: var(--btn-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            margin: 0 auto;
        }
        .btn:active {
            background: var(--btn-active);
            transform: scale(0.95);
        }
        #score-display {
            color: white;
            text-align: center;
            font-size: 20px;
            padding: 10px;
        }
        #leaderboard {
            color: white;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        @media (max-width: 400px) {
            canvas {
                width: 95vw;
                height: 95vw;
            }
            .btn {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="score-display">–û—á–∫–∏: 0</div>
        <canvas id="gameCanvas" width="300" height="300"></canvas>

        <div id="controls">
            <div></div>
            <button class="btn" id="up">‚Üë</button>
            <div></div>
            <button class="btn" id="left">‚Üê</button>
            <button class="btn" id="down">‚Üì</button>
            <button class="btn" id="right">‚Üí</button>
        </div>

        <div id="leaderboard">
            <h3>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:</h3>
            <ol id="scores-list"></ol>
        </div>

        <div id="game-over">
            <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
            <p id="final-score">–û—á–∫–∏: 0</p>
            <button id="restart-btn">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        const config = {
            initialSpeed: 150,
            speedIncrease: 5,
            minSpeed: 50
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 10;
        const tileCount = canvas.width / gridSize;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameSpeed = config.initialSpeed;
        let gameLoopId = null;
        let isGameOver = false;
        let playerName = '–ò–≥—Ä–æ–∫';

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const scoreDisplay = document.getElementById('score-display');
        const scoresList = document.getElementById('scores-list');
        const gameOverDiv = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB
        const dbRequest = indexedDB.open('SnakeGameDB', 2);

        dbRequest.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('scores')) {
                const store = db.createObjectStore('scores', {
                    keyPath: 'id',
                    autoIncrement: true
                });
                store.createIndex('score', 'score', { unique: false });
                store.createIndex('name', 'name', { unique: false });
            }
        };

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π
        function initGame() {
            snake = [{x: 15 * gridSize, y: 15 * gridSize}];
            food = generateFood();
            dx = gridSize;
            dy = 0;
            score = 0;
            gameSpeed = config.initialSpeed;
            isGameOver = false;

            scoreDisplay.textContent = `–û—á–∫–∏: ${score}`;
            gameOverDiv.style.display = 'none';

            if (gameLoopId) clearInterval(gameLoopId);
            gameLoopId = setInterval(gameLoop, gameSpeed);
        }

        function generateFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * tileCount) * gridSize,
                    y: Math.floor(Math.random() * tileCount) * gridSize
                };
            } while (snake.some(segment =>
                segment.x === newFood.x && segment.y === newFood.y
            ));

            return newFood;
        }

        function gameLoop() {
            if (isGameOver) return;

            const head = {
                x: snake[0].x + dx,
                y: snake[0].y + dy
            };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
            if (head.x < 0) head.x = canvas.width - gridSize;
            if (head.x >= canvas.width) head.x = 0;
            if (head.y < 0) head.y = canvas.height - gridSize;
            if (head.y >= canvas.height) head.y = 0;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
            if (snake.some(segment =>
                segment.x === head.x && segment.y === head.y
            )) {
                endGame();
                return;
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≥–æ–ª–æ–≤—ã
            snake.unshift(head);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—ä–µ–¥–µ–Ω–∏—è –ø–∏—â–∏
            if (head.x === food.x && head.y === food.y) {
                vibrate(50);
                score++;
                scoreDisplay.textContent = `–û—á–∫–∏: ${score}`;
                food = generateFood();

                // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
                if (score % 5 === 0 && gameSpeed > config.minSpeed) {
                    gameSpeed -= config.speedIncrease;
                    clearInterval(gameLoopId);
                    gameLoopId = setInterval(gameLoop, gameSpeed);
                }
            } else {
                snake.pop();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawGame();
        }

        function drawGame() {
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–º–µ–π–∫–∏
            ctx.fillStyle = '#4CAF50';
            snake.forEach(segment => {
                ctx.fillRect(segment.x, segment.y, gridSize, gridSize);
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∏—â–∏
            ctx.fillStyle = '#FF5252';
            ctx.beginPath();
            ctx.arc(
                food.x + gridSize/2,
                food.y + gridSize/2,
                gridSize/2,
                0,
                Math.PI * 2
            );
            ctx.fill();
        }

        function endGame() {
            isGameOver = true;
            clearInterval(gameLoopId);

            finalScoreDisplay.textContent = `–û—á–∫–∏: ${score}`;
            gameOverDiv.style.display = 'block';

            saveScore();
            loadLeaderboard();

            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function vibrate(duration) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        function saveScore() {
            const db = dbRequest.result;
            const transaction = db.transaction(['scores'], 'readwrite');
            const store = transaction.objectStore('scores');

            store.add({
                name: playerName,
                score: score,
                date: new Date().toISOString()
            });
        }

        function loadLeaderboard() {
            const db = dbRequest.result;
            const transaction = db.transaction(['scores'], 'readonly');
            const store = transaction.objectStore('scores');
            const index = store.index('score');

            const request = index.openCursor(null, 'prev');
            const topScores = [];

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && topScores.length < 10) {
                    topScores.push(cursor.value);
                    cursor.continue();
                } else {
                    displayLeaderboard(topScores);
                }
            };
        }

        function displayLeaderboard(scores) {
            scoresList.innerHTML = '';
            scores.forEach((item, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${item.name}: ${item.score}`;
                scoresList.appendChild(li);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function changeDirection(newDx, newDy) {
            if ((dx === 0 && newDx !== 0) || (dy === 0 && newDy !== 0)) {
                dx = newDx;
                dy = newDy;
                vibrate(20);
            }
        }

        // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document.getElementById('up').addEventListener('click', () => changeDirection(0, -gridSize));
        document.getElementById('down').addEventListener('click', () => changeDirection(0, gridSize));
        document.getElementById('left').addEventListener('click', () => changeDirection(-gridSize, 0));
        document.getElementById('right').addEventListener('click', () => changeDirection(gridSize, 0));

        // –°–µ–Ω—Å–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        ['touchstart', 'touchend'].forEach(event => {
            document.getElementById('up').addEventListener(event, (e) => {
                e.preventDefault();
                changeDirection(0, -gridSize);
            });
            document.getElementById('down').addEventListener(event, (e) => {
                e.preventDefault();
                changeDirection(0, gridSize);
            });
            document.getElementById('left').addEventListener(event, (e) => {
                e.preventDefault();
                changeDirection(-gridSize, 0);
            });
            document.getElementById('right').addEventListener(event, (e) => {
                e.preventDefault();
                changeDirection(gridSize, 0);
            });
        });

        restartBtn.addEventListener('click', initGame);

        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();

            const user = Telegram.WebApp.initDataUnsafe.user;
            if (user) {
                playerName = user.first_name || '–ò–≥—Ä–æ–∫';
                if (user.last_name) playerName += ` ${user.last_name}`;
            }
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        dbRequest.onsuccess = () => {
            loadLeaderboard();
            initGame();
        };
    </script>
</body>
</html>